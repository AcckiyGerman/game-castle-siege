<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Castle Siege</title>
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1.0, minimal-ui, user-scalable=no' />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<link rel="stylesheet" href="js/scroller/jquery.mCustomScrollbar.min.css" />
    <link rel="stylesheet" href="game.css" />
	<link href="https://fonts.googleapis.com/css?family=Raleway&amp;subset=latin-ext" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.10/webfont.js"></script>
	<script>
		window.addEventListener("load", function() {
			function onTouchPreventDefault(event) { event.preventDefault(); };
			document.addEventListener("touchmove", onTouchPreventDefault, false);
			document.addEventListener("touchstart", onTouchPreventDefault, false);
		}, false);

		window.addEventListener('scroll', function ()
		{
			document.body.scrollTop = 0;
		}, true);

		window.addEventListener('resize', function ()
		{
			document.body.scrollTop = 0;
		}, true);

	</script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
	<script src="js/scroller/jquery.mCustomScrollbar.concat.min.js"></script>

    <!--phaser scripts and stages-->
    <script src="js/phaser.js"></script>
	<script src="js/commons.js"></script>
	<script src="js/boot.js"></script>
	<script src="js/preload.js"></script>
	<script src="js/menu.js"></script>
	<script src="js/rules.js"></script>
	<script src="js/settings.js"></script>
	<script src="js/questions.js"></script>
	<script src="js/climbers.js"></script>
	<script src="js/game.js"></script>
	<script src="js/play.js"></script>
	<script src="js/winner.js"></script>
	
	<script type="text/javascript">
		function downloadQuestions() {
			var questions = $("INPUT.input-question");
			//validation
			for (var i=0; i<questions.length; i++) {
				if ($(questions[i]).val().trim() == "") {
					showDialog("Question #" + (i+1)  + " can't be empty!");
					return;
				}
			}
			
			var tmpQuestions = [];
			for (var i=0; i<questions.length; i++) {
				tmpQuestions[i] = $(questions[i]).val();
			}
			
			res = {"version": 1.0, "questions": "" + CryptoJS.AES.encrypt(JSON.stringify(tmpQuestions), "k234n111!?-Mnkw#")};
			uriContent = "data:application/octet-stream," + encodeURIComponent(JSON.stringify(res));
			var x = $("<a download='questions.data' href='" + uriContent + "'></a>");
			
			x.appendTo('body');
			x[0].click();
			x.remove();
		}
		function hideQuestions() {
			var questions = $("INPUT.input-question");
			//validation
			for (var i=0; i<questions.length; i++) {
				if ($(questions[i]).val().trim() == "") {
					showDialog("Question #" + (i+1)  + " can't be empty!");
					return;
				}
			}
			Global.questions = [];
			for (var i=0; i<questions.length; i++) {
				Global.questions[i] = {
					"q": $(questions[i]).val()
				}
			}
			document.getElementById("questions-form").style.display = "none";
			questionsState.onSubmitClicked();
		}
		function showDialog(message) {
			$("#dialog-text").html(message);
			$("#dialog").show();
			
		}
		function hideDialog() {
			$("#dialog").hide();
		}
		function hideClimbers() {
			var climberNames = $("INPUT.climber-team-name");
			//validation
			for (var i=0; i<climberNames.length; i++) {
				if ($(climberNames[i]).val().trim() == "") {
					showDialog("Climber #" + (i+1)  + " needs a name!");
					return;
				}
			}
			
			var avatars = $(".climber-avatar");
			for (var i=0; i<climberNames.length; i++) {
				Global.players[i].name = $(climberNames[i]).val().trim();
				Global.players[i].avatar = $(avatars[i]).data("id");
			}
			
			document.getElementById("climbers-form").style.display = "none";
			climbersState.onSubmitClicked();
		}
		
		function showQuestions() {
			//remove all questions
			$("#questions").html("");
			for (var i=0; i<Global.questions.length; i++)
				addQuestion(Global.questions[i].q, false);
			document.getElementById("questions-form").style.display = "block";
			updateSize();
		}
		
		function showClimbers() {
			document.getElementById("climbers-form").style.display = "block";
			$("#climbers").html("");
			for (var i=0; i<Global.players.length; i++)
				addClimber(Global.players[i].name, Global.players[i].avatar);
			updateSize();
		}
		
		function removeQuestion(row) {
			var id = row.data("id");
			row.remove();
			var i = 0;
			$(".question-row").each(function(){
				$("span", this).html("Question " + (i+1));
				$(this).data("id", i);
				i++;
			});
			$("#questions-scrollbar-holder").mCustomScrollbar("update");
			if ($("#questions").first().children().length <= Global.minQuestions) $(".button-delete").hide();
		}
		
		function updateSize() {
			document.getElementById("questions-form").style.width = (game.canvas.clientWidth) + "px";
			document.getElementById("questions-form").style.height = (game.canvas.clientHeight) + "px";
			document.getElementById("questions-form").style.marginLeft = game.canvas.style.marginLeft;
			
			document.getElementById("climbers-form").style.width = (game.canvas.clientWidth) + "px";
			document.getElementById("climbers-form").style.height = (game.canvas.clientHeight) + "px";
			document.getElementById("climbers-form").style.marginLeft = game.canvas.style.marginLeft;
			
			document.getElementById("dialog").style.width = (game.canvas.clientWidth) + "px";
			document.getElementById("dialog").style.height = (game.canvas.clientHeight) + "px";
			document.getElementById("dialog").style.marginLeft = game.canvas.style.marginLeft;
			
		}
		
		function addQuestion(text, scrollDown) {
			var noOfQuestion = $("#questions").first().children().length;
			$("#questions").append(
				'<div data-id="' + noOfQuestion + '" class="question-row">' +
				'	<span class="question">Question ' + (noOfQuestion+1) + '</span>' +
				'	<input class="input-question" type="text" value=""/>' +
				'   <div class="button-delete" onclick="removeQuestion($(this).parent())"></div>' +
				'</div>'
			);
			$("INPUT", $("#questions :last-child")).val(text);
			if (scrollDown)
				$("#questions-scrollbar-holder").mCustomScrollbar("scrollTo","bottom");
			if (noOfQuestion+1 > Global.minQuestions) $(".button-delete").show();
			if ($("#questions").first().children().length <= Global.minQuestions) $(".button-delete").hide();
		}
		
		function addClimber(playerName, knightColor) {
			//var noOfClimbers = $("#climbers").first().children().length;
			$("#climbers").append(
				'<div class="climber">' +
				'	<input class="climber-team-name" type="text" placeholder="Knight Name"/>' +
				'	<br/>' +
				'	<div class="climber-avatar">' +
				'		<img src="assets/knights/KnightFront' + knightColor + '.png"' +
                '            onclick="changePlayerColor($(this)[0])"' +
				'			 alt="' + knightColor + '"/>' +  // identify knight by this
				'	</div>' + 
				//'	<br style="clear:both" />' +
				//'	<button class="climber-left" onclick="onLeftClicked($(this).parent())"></button>' +
				//'	<button class="climber-right" onclick="onRightClicked($(this).parent())"></button>' +
				'</div>'
			);
			$("INPUT", $("#climbers :last-child")).val(playerName);
		}

		function changePlayerColor(playerImg){
		    var currentColor = playerImg.alt;
			var player = Global.players.filter(function(player){
			    return player.avatar === currentColor
			})[0];
			console.log('Change color for', player.name);

			var freeColors = Global.knightColors.filter(function(color){
			    var colorIsFree = true;
			    Global.players.forEach(function(player){
			        if (player.avatar === color)
			            colorIsFree = false
				});
				return colorIsFree
			});

			if (freeColors.length == 0){
			    console.warn('no free colors to choose');
				return
			}

			var newColor = freeColors[Math.floor(Math.random() * freeColors.length)];
			player.avatar = newColor;
			playerImg.alt = newColor;
			playerImg.src = "assets/knights/KnightFront" + newColor + ".png";
        }
	</script>
</head>
<body>
	<div id="game" style="height:100%">
		<div id="questions-form" style="display:none">
			<div id="questions-scrollbar-holder">
				<div id="questions">
				</div>
				<button id="button-plus" onclick="addQuestion('', true)"></button>
			</div>
			<button id="button-download" onclick="downloadQuestions()"></button> 
			<button id="button-submit" onclick="hideQuestions()"></button> 
		</div>
		<div id="climbers-form" style="display:none">
			<div id="climbers-scrollbar-holder">
                <div class="flex">
                    <div id="climbers-legend">
                        <p>Name</p>
                        <p>Select your knight:</p>
                    </div>
                    <div id="climbers"></div>
                </div>
			</div>
			<button id="button-climbers-submit" onclick="hideClimbers()"></button> 
		</div>
		<div id="dialog" style="display:none">
			<div id="dialog-bg">
				<div id="dialog-text">
				</div>
				<button id="button-dialog-ok" onclick="hideDialog()"></button> 
			</div>
		</div>
	</div>
</body>
</html>